Of course, here is the README content for your backend API documentation.

# Employee Management Backend API

This document provides a comprehensive guide to the API endpoints for the Employee Management backend. The API is built with Node.js, Express, and Firebase.

## Getting Started

### Prerequisites

- Node.js (v18 or later)
- npm or yarn
- A Firebase project with Firestore and Authentication enabled.

### Installation

1.  Install dependencies:

    ```bash
    npm install
    ```

2.  Set up environment variables:
    Create a `.env` file in the root of the `backend` directory and add your Firebase project configuration. You can get this from the Firebase console.

    ```env
    PORT=8000
    CORS_ORIGIN=http://localhost:3000
    FIREBASE_DATABASE_URL=
    ADMIN_UID=
    FIREBASE_SERVICE_ACCOUNT_JSON=
    FIREBASE_WEB_API_KEY=
    ```

3.  Start the server:

    ```bash
    npm run dev
    ```

    The server will start on `http://localhost:3000` by default.

## Authentication

All protected routes require a JSON Web Token (JWT) to be passed in the `Authorization` header.

**Format:** `Authorization: Bearer <your_jwt_token>`

To obtain a token, you must authenticate a user through Firebase Authentication on your client application. The ID token generated by Firebase is the JWT you should use.

---

## API Routes

The base URL for all API routes is `/api`.

### User Routes

These routes are accessible to all authenticated users.

#### 1\. Assign a New Work Bundle

- **Endpoint:** `POST /data/assign-bundle`

- **Description:** Assigns a new work bundle to the authenticated user for a specific _taluka_. The system will automatically find the next available bundle number.

- **Request Body:**

  ```json
  {
    "taluka": "Paithan"
  }
  ```

- **Success Response (200 OK):**

  ```json
  {
    "message": "Bundle #1 assigned successfully for Paithan.",
    "bundle": {
      "taluka": "Paithan",
      "bundleNo": 1,
      "count": 0
    }
  }
  ```

- **Error Responses:**

  - `400 Bad Request`: If `taluka` is not provided.
  - `409 Conflict`: If the user already has an active, incomplete bundle for that _taluka_.

#### 2\. Sync Processed Records

- **Endpoint:** `POST /data/sync-records`

- **Description:** Saves a batch of processed records to the server for a specific bundle.

- **Request Body:**

  ```json
  {
    "bundleNo": 1,
    "taluka": "Paithan",
    "records": [
      {
        "uniqueId": "CSKN0",
        "processedAt": "2024-07-22T12:00:00.000Z",
        "content": {
          "Search from": "12345",
          "Name": "John Doe",
          "Taluka": "Paithan"
        }
      },
      {
        "uniqueId": "CSKN1",
        "processedAt": "2024-07-22T12:01:00.000Z",
        "content": {
          "Search from": "67890",
          "Name": "Jane Smith",
          "Taluka": "Paithan"
        }
      }
    ]
  }
  ```

- **Success Response (200 OK):**

  ```json
  {
    "message": "2 records synced successfully for bundle #1.",
    "newCount": 2
  }
  ```

- **Error Response:**

  - `400 Bad Request`: If required fields are missing.

#### 3\. Mark a Bundle as Complete

- **Endpoint:** `POST /data/complete-bundle`

- **Description:** Marks the user's active bundle for a specific _taluka_ as complete. This is typically done when the user has processed all records in the bundle.

- **Request Body:**

  ```json
  {
    "taluka": "Paithan"
  }
  ```

- **Success Response (200 OK):**

  ```json
  {
    "message": "Bundle for Paithan marked as complete."
  }
  ```

- **Error Response:**

  - `404 Not Found`: If the user has no active bundle for the specified _taluka_.

#### 4\. Get Active Bundles

- **Endpoint:** `GET /data/active-bundles`

- **Description:** Retrieves the authenticated user's currently active work bundles.

- **Success Response (200 OK):**

  ```json
  {
    "Paithan": {
      "taluka": "Paithan",
      "bundleNo": 1,
      "count": 150
    },
    "Kannad": {
      "taluka": "Kannad",
      "bundleNo": 3,
      "count": 25
    }
  }
  ```

---

### Admin Routes

These routes require the authenticated user to have an `admin` role.

#### 1\. Get All Users

- **Endpoint:** `GET /users`

- **Description:** Retrieves a list of all users in the system.

- **Success Response (200 OK):**

  ```json
  [
    {
      "id": "firebase_uid_1",
      "name": "John Doe",
      "username": "john.d",
      "location": "chhatrapati-sambhajinagar"
    },
    {
      "id": "firebase_uid_2",
      "name": "Jane Smith",
      "username": "jane.s",
      "location": "ahilyanagar"
    }
  ]
  ```

#### 2\. Create a New User

- **Endpoint:** `POST /users`

- **Description:** Creates a new user in both Firebase Authentication and the application's database.

- **Request Body:**

  ```json
  {
    "name": "New User",
    "username": "new.user",
    "mobile": "1234567890",
    "location": "ahilyanagar",
    "excelFile": "ahilyanagar_data.xlsx"
  }
  ```

- **Success Response (201 Created):**

  ```json
  {
    "message": "User created successfully",
    "user": {
      "id": "new_firebase_uid",
      "name": "New User",
      "username": "new.user",
      "mobile": "1234567890",
      "location": "ahilyanagar",
      "excelFile": "ahilyanagar_data.xlsx"
    }
  }
  ```

#### 3\. Upload an Excel File

- **Endpoint:** `POST /data/upload/:location`

- **Description:** Uploads an Excel file for a specific location. The file should be sent as `multipart/form-data`.

- **URL Parameter:**

  - `location`: The slug of the location (e.g., `chhatrapati-sambhajinagar`).

- **Form Data:**

  - `file`: The Excel file (`.xls` or `.xlsx`).

- **Success Response (200 OK):**

  ```json
  {
    "message": "File uploaded and processed successfully.",
    "fileName": "your_file_name.xlsx",
    "recordCount": 5000
  }
  ```

#### 4\. Export Processed Data

- **Endpoint:** `GET /admin/export/:location`
- **Description:** Exports all processed records for a given location as an Excel file.
- **URL Parameter:**
  - `location`: The slug of the location (e.g., `ahilyanagar`).
- **Success Response (200 OK):**
  - The response will be an Excel file (`.xlsx`) download.

#### 5\. Get Bundle Counters Status

- **Endpoint:** `GET /admin/bundle-counters`

- **Description:** Retrieves the current status of all bundle counters for all locations and _talukas_.

- **Success Response (200 OK):**

  ```json
  {
    "chhatrapati-sambhajinagar": {
      "Paithan": {
        "nextBundle": 5,
        "gaps": [2]
      },
      "Kannad": {
        "nextBundle": 4
      }
    }
  }
  ```

#### 6\. Reset User Progress

- **Endpoint:** `POST /admin/reset-user-progress`

- **Description:** Resets a user's progress for a specific _taluka_. This action deletes their processed records for that bundle, recycles the bundle number, and sends a reset signal to the user's device.

- **Request Body:**

  ```json
  {
    "userId": "firebase_uid_to_reset",
    "taluka": "Paithan"
  }
  ```

- **Success Response (200 OK):**

  ```json
  {
    "message": "Successfully deleted 150 records, recycled bundle #1, and sent a reset signal to John Doe for Paithan."
  }
  ```

#### 7\. Force Complete a Bundle

- **Endpoint:** `POST /admin/force-complete-bundle`

- **Description:** Manually marks a specific bundle number as complete. This is useful for closing old or stuck bundles.

- **Request Body:**

  ```json
  {
    "userId": "firebase_uid_of_user",
    "taluka": "Paithan",
    "bundleNo": 1
  }
  ```

- **Success Response (200 OK):**

  ```json
  {
    "message": "Bundle #1 for Paithan is now marked as complete by admin."
  }
  ```

#### 8\. Manually Assign a Bundle

- **Endpoint:** `POST /admin/manual-assign-bundle`

- **Description:** Manually assigns a specific bundle number to a user, overriding their current active bundle for that _taluka_.

- **Request Body:**

  ```json
  {
    "userId": "firebase_uid_of_user",
    "taluka": "Kannad",
    "bundleNo": 5
  }
  ```

- **Success Response (200 OK):**

  ```json
  {
    "message": "Bundle #5 has been assigned to John Doe for Kannad. Their device will update shortly."
  }
  ```

#### 9\. Reset All Processed Data (Danger Zone)

- **Endpoint:** `DELETE /admin/reset-all-data`

- **Description:** **IRREVERSIBLE ACTION.** Deletes all processed records from the entire system.

- **Success Response (200 OK):**

  ```json
  {
    "message": "All processed data has been permanently deleted."
  }
  ```

#### 10\. Reset All Counters (Danger Zone)

- **Endpoint:** `DELETE /admin/reset-all-counters`

- **Description:** **IRREVERSIBLE ACTION.** Resets all bundle counters and user states, effectively starting the bundle assignment system from scratch.

- **Success Response (200 OK):**

  ```json
  {
    "message": "All bundle counters and user states have been reset."
  }
  ```
